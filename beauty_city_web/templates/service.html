{% extends "base.html" %}
{% load static %}
<head>
    {% block head %}
    <link rel="stylesheet" href="{% static 'css/jquery.arcticmodal-0.3.css' %}">
    
    <style>
    .accordion__block {
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .accordion__block:hover {
        background-color: #f5f5f5;
    }
    .accordion__block_item {
        cursor: pointer;
        padding: 8px 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    .accordion__block_item:hover {
        background-color: #f9f9f9;
    }
    .accordion__block_img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
    }
    .time__elems_btn.active {
        background-color: #ffcc00;
        color: #000;
    }
    .time__elems_btn.selected {
        border: 2px solid #ff6600;
    }
    .time__elems_btn {
        margin: 5px;
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .time__elems_btn:hover {
        background: #f5f5f5;
    }
    .date-picker-container {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        height: 100%;
    }
    .date-picker-container label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #333;
    }
    .date-picker-container input[type="date"] {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .time__btns {
        margin-top: 30px;
        text-align: center;
    }
    .time__btns_next, .time__btns_home {
        padding: 12px 30px;
        margin: 0 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }
    .time__btns_next {
        background: #ffcc00;
        color: #000;
    }
    .time__btns_next:hover {
        background: #ffd633;
    }
    .time__btns_home {
        background: #f0f0f0;
        color: #333;
    }
    .time__btns_home:hover {
        background: #e0e0e0;
    }
    </style>
    {% endblock head %}
</head>
<body class="servicePage">
  {% block content %}
	<section id="service">
		<div class="container">
			<div class="service">
				<div class="breadCrumbs">
					<a href="{% url 'beauty_city_web:index' %}" class="breadCrumbs__item">На главную</a>
				</div>
				<div class="service__block">
					<h1 class="service__title">Запись на услугу</h1>
					<button class="service__btn btn telephoneAppointmentOpen">Запись по телефону</button>
				</div>
				<form action="#" class="service__form">
					<div class="service__form_block service__salons">
						<button class="accordion" type="button">(Выберите салон)</button>
						<div class="panel" style="display: none;">
						</div>
					</div>
					<div class="service__form_block service__services">
						<button class="accordion" type="button">(Выберите услугу)</button>
						<div class="panel" style="display: none;">
						</div>
					</div>
					<div class="service__form_block service__masters">
						<button class="accordion" type="button">(Выберите мастера)</button>
						<div class="panel" style="display: none;">
						</div>
					</div>
				</form>
			</div>
		</div>
	</section>
	<section id="time">
		<div class="container">
			<div class="time">
				<h2 class="time__title">Выберите время</h2>
				<div class="time__block">
					<div class="row">
						<div class="col-md-4">
							<div class="date-picker-container">
								<label for="appointmentDate">Выберите дату:</label>
								<input type="date" id="appointmentDate" 
									   min="{% now 'Y-m-d' %}"
									   style="width: 100%; padding: 12px; font-size: 16px;">
								<div id="selectedDateInfo" style="margin-top: 10px; font-style: italic; color: #666; display: none;">
									Выбрана дата: <span id="selectedDateText"></span>
								</div>
							</div>
						</div>
						<div class="col-md-8">
							<div class="time__elems">
								<div class="time__items">
									<div class="time__elems_intro">Утро (10:00 - 12:00)</div>
									<div class="time__elems_elem fic">
										<button data-time="10:00" class="time__elems_btn">10:00</button>
										<button data-time="10:30" class="time__elems_btn">10:30</button>
										<button data-time="11:00" class="time__elems_btn">11:00</button>
										<button data-time="11:30" class="time__elems_btn">11:30</button>
									</div>
								</div>
								<div class="time__items">
									<div class="time__elems_intro">День (12:00 - 17:00)</div>
									<div class="time__elems_elem fic">
										<button data-time="12:00" class="time__elems_btn">12:00</button>
										<button data-time="12:30" class="time__elems_btn">12:30</button>
										<button data-time="13:00" class="time__elems_btn">13:00</button>
										<button data-time="13:30" class="time__elems_btn">13:30</button>
										<button data-time="14:00" class="time__elems_btn">14:00</button>
										<button data-time="14:30" class="time__elems_btn">14:30</button>
										<button data-time="15:00" class="time__elems_btn">15:00</button>
										<button data-time="15:30" class="time__elems_btn">15:30</button>
										<button data-time="16:00" class="time__elems_btn">16:00</button>
										<button data-time="16:30" class="time__elems_btn">16:30</button>
									</div>
								</div>
								<div class="time__items">
									<div class="time__elems_intro">Вечер (17:00 - 20:00)</div>
									<div class="time__elems_elem fic">
										<button data-time="17:00" class="time__elems_btn">17:00</button>
										<button data-time="17:30" class="time__elems_btn">17:30</button>
										<button data-time="18:00" class="time__elems_btn">18:00</button>
										<button data-time="18:30" class="time__elems_btn">18:30</button>
										<button data-time="19:00" class="time__elems_btn">19:00</button>
										<button data-time="19:30" class="time__elems_btn">19:30</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="time__btns">
					<div class="row">
						<div class="col-md-12">
							<button class="time__btns_next">Далее</button>
							<button class="time__btns_home">На главную</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	{% endblock content %}
	{% block popups %}
	<div style="display: none;">
		<div class="box-modal tipsPopup popup" style="width: 500px;" id="appointmentModal">
			<div class="box-modal_close arcticmodal-close"><img src="{% static 'img/x.svg' %}" alt="x"></div>
			<div class="popup__title reviewPopup__title" style="padding-left: 40px;">Номер для записи</div>
			<a href="tel:+79179023800" class="contacts__info_tel" style="padding-left: 135px;">+7 (917) 902 38 00</a>
		</div>
	</div>
	{% endblock popups %}
	{% block scripts %}
	<script src="{% static 'js/jquery.arcticmodal-0.3.min.js' %}"></script>
	
	<script>
$(document).ready(function() {
    console.log('=== Страница записи загружена ===');
    
    var DEFAULT_AVATAR_URL = '/static/img/avatars/default.svg';
    var selectedData = {
        salon: null,
        service: null,
        master: null,
        date: null,
        time: null
    };
    
    // Форматирование даты
    function formatDate(dateString) {
        var date = new Date(dateString);
        var options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        return date.toLocaleDateString('ru-RU', options);
    }

    // Функция валидации даты и времени
    function validateDateTime(selectedDate, selectedTime) {
        if (!selectedDate || !selectedTime) return false;
        
        var now = new Date();
        var selectedDateTime = new Date(selectedDate + 'T' + selectedTime + ':00');
        
        // Проверка, что время не в прошлом
        if (selectedDateTime < now) {
            alert('Нельзя записаться на прошедшее время');
            return false;
        }
        
        // Проверка на сегодня - минимум через час
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var selectedDateOnly = new Date(selectedDate);
        selectedDateOnly.setHours(0, 0, 0, 0);
        
        if (selectedDateOnly.getTime() === today.getTime()) {
            var oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            if (selectedDateTime < oneHourLater) {
                alert('При записи на сегодня минимальное время через 1 час');
                return false;
            }
        }
        
        // Проверка рабочего времени (10:00-19:00 с шагом 30 минут)
        var hour = parseInt(selectedTime.split(':')[0]);
        var minute = parseInt(selectedTime.split(':')[1]);
        
        if (hour < 10 || hour > 19) {
            alert('Время должно быть с 10:00 до 19:00');
            return false;
        }
        
        if (minute !== 0 && minute !== 30) {
            alert('Время должно быть с шагом 30 минут (например: 10:00, 10:30)');
            return false;
        }
        
        if (hour === 19 && minute > 0) {
            alert('Последнее доступное время - 19:00');
            return false;
        }
        
        return true;
    }
    
    // Функция для фильтрации опций
    function filterOptions() {
        console.log('Фильтрация опций с данными:', selectedData);
        
        // Если выбран мастер, фильтруем салоны и услуги по мастеру
        if (selectedData.master) {
            loadSalons({ master_id: selectedData.master.id });
            loadServices({ 
                master_id: selectedData.master.id,
                salon_id: selectedData.salon ? selectedData.salon.id : null
            });
        }
        // Если выбран салон, фильтруем мастеров и услуги по салону
        else if (selectedData.salon) {
            loadMasters({ salon_id: selectedData.salon.id });
            loadServices({ salon_id: selectedData.salon.id });
        }
        // Если выбрана услуга, фильтруем мастеров и салоны по услуге
        else if (selectedData.service) {
            loadMasters({ service_id: selectedData.service.id });
            loadSalons({ service_id: selectedData.service.id });
        }
        // Если ничего не выбрано, загружаем все
        else {
            loadSalons();
            loadServices();
            loadMasters();
        }
    }
    
    // Функция обновления текста кнопок
    function updateButtonTexts() {
        if (selectedData.salon) {
            $('.service__salons .accordion').text(selectedData.salon.name);
        } else {
            $('.service__salons .accordion').text('(Выберите салон)');
        }
        
        if (selectedData.service) {
            $('.service__services .accordion').text(selectedData.service.name);
        } else {
            $('.service__services .accordion').text('(Выберите услугу)');
        }
        
        if (selectedData.master) {
            $('.service__masters .accordion').text(selectedData.master.name);
        } else {
            $('.service__masters .accordion').text('(Выберите мастера)');
        }
    }
    
    // Обработчики аккордеонов
    $(document).on('click', '.accordion', function(e) {
        e.stopPropagation();
        $(this).toggleClass("active");
        $(this).next(".panel").slideToggle(200);
    });

    $('.service__salons .accordion').on('click', function() {
        if ($('.service__salons .panel').is(':visible') && !$(this).hasClass('loaded')) {
            var params = {};
            if (selectedData.master) params.master_id = selectedData.master.id;
            if (selectedData.service) params.service_id = selectedData.service.id;
            loadSalons(params);
            $(this).addClass('loaded');
        }
    });

    $('.service__services .accordion').on('click', function() {
        if ($('.service__services .panel').is(':visible') && !$(this).hasClass('loaded')) {
            var params = {};
            if (selectedData.master) params.master_id = selectedData.master.id;
            if (selectedData.salon) params.salon_id = selectedData.salon.id;
            loadServices(params);
            $(this).addClass('loaded');
        }
    });

    $('.service__masters .accordion').on('click', function() {
        if ($('.service__masters .panel').is(':visible') && !$(this).hasClass('loaded')) {
            var params = {};
            if (selectedData.salon) params.salon_id = selectedData.salon.id;
            if (selectedData.service) params.service_id = selectedData.service.id;
            loadMasters(params);
            $(this).addClass('loaded');
        }
    });

    // Функция загрузки салонов с фильтрацией
    function loadSalons(params = {}) {
        console.log('Загрузка салонов с параметрами:', params);
        
        var url = '/api/salons/';
        var queryParams = [];
        
        if (params.master_id) queryParams.push('master_id=' + params.master_id);
        if (params.service_id) queryParams.push('service_id=' + params.service_id);
        
        if (queryParams.length > 0) {
            url += '?' + queryParams.join('&');
        }
        
        $.ajax({
            url: url,
            type: 'GET',
            success: function(data) {
                console.log('Салонов загружено:', data.salons.length);
                var $panel = $('.service__salons .panel');
                $panel.empty();
                
                if (data.salons.length === 0) {
                    $panel.html('<div class="accordion__block">Нет доступных салонов по выбранным критериям</div>');
                    return;
                }
                
                data.salons.forEach(function(salon) {
                    var $salonBlock = $(
                        '<div class="accordion__block fic">' +
                        '<div class="accordion__block_intro">' + salon.name + '</div>' +
                        '<div class="accordion__block_address">' + salon.address + '</div>' +
                        '</div>'
                    );
                    
                    $salonBlock.on('click', function() {
                        console.log('Выбран салон:', salon.name);
                        
                        // Сохраняем выбранный салон
                        selectedData.salon = {
                            id: salon.id,
                            name: salon.name,
                            address: salon.address
                        };
                        
                        updateButtonTexts();
                        $('.service__salons .accordion').removeClass('active');
                        $panel.slideUp(200);
                        
                        // Фильтруем другие опции
                        filterOptions();
                    });
                    
                    $panel.append($salonBlock);
                });
            },
            error: function(error) {
                console.error('Ошибка загрузки салонов:', error);
                alert('Не удалось загрузить список салонов');
            }
        });
    }

    // Функция загрузки услуг с фильтрацией
    function loadServices(params = {}) {
        console.log('Загрузка услуг с параметрами:', params);
        
        var url = '/api/services/';
        var queryParams = [];
        
        if (params.salon_id) queryParams.push('salon_id=' + params.salon_id);
        if (params.master_id) queryParams.push('master_id=' + params.master_id);
        
        if (queryParams.length > 0) {
            url += '?' + queryParams.join('&');
        }
        
        $.ajax({
            url: url,
            type: 'GET',
            success: function(data) {
                console.log('Категорий услуг загружено:', data.categories.length);
                var $panel = $('.service__services .panel');
                $panel.empty();
                
                if (data.categories.length === 0) {
                    $panel.html('<div class="accordion__block">Нет доступных услуг по выбранным критериям</div>');
                    return;
                }
                
                data.categories.forEach(function(category) {
                    var $categoryBtn = $(
                        '<button class="accordion" type="button">' + category.name + '</button>'
                    );
                    
                    var $categoryPanel = $('<div class="panel" style="display: none;"></div>');
                    
                    category.services.forEach(function(service) {
                        var $serviceItem = $(
                            '<div class="accordion__block_item fic">' +
                            '<div class="accordion__block_item_intro">' + service.name + '</div>' +
                            '<div class="accordion__block_item_address">' + service.price + ' ₽</div>' +
                            '</div>'
                        );
                        
                        $serviceItem.on('click', function(e) {
                            e.stopPropagation();
                            
                            // Сохраняем выбранную услугу
                            selectedData.service = {
                                id: service.id,
                                name: service.name,
                                price: service.price
                            };
                            
                            updateButtonTexts();
                            $('.service__services .accordion').removeClass('active');
                            $('.service__services .panel').slideUp(200);
                            
                            // Фильтруем другие опции
                            filterOptions();
                        });
                        
                        $categoryPanel.append($serviceItem);
                    });
                    
                    $panel.append($categoryBtn);
                    $panel.append($categoryPanel);
                });
            },
            error: function(error) {
                console.error('Ошибка загрузки услуг:', error);
                alert('Не удалось загрузить список услуг');
            }
        });
    }

    // Функция загрузки мастеров с фильтрацией
    function loadMasters(params = {}) {
        console.log('Загрузка мастеров с параметрами:', params);
        
        var url = '/api/masters/';
        var queryParams = [];
        
        if (params.salon_id) queryParams.push('salon_id=' + params.salon_id);
        if (params.service_id) queryParams.push('service_id=' + params.service_id);
        
        if (queryParams.length > 0) {
            url += '?' + queryParams.join('&');
        }
        
        $.ajax({
            url: url,
            type: 'GET',
            success: function(data) {
                console.log('Мастеров загружено:', data.masters.length);
                var $panel = $('.service__masters .panel');
                $panel.empty();
                
                if (data.masters.length === 0) {
                    $panel.html('<div class="accordion__block">Нет доступных мастеров по выбранным критериям</div>');
                    return;
                }
                
                data.masters.forEach(function(master) {
                    var photoUrl = master.photo_url || DEFAULT_AVATAR_URL;
                    var $masterBlock = $(
                        '<div class="accordion__block fic">' +
                        '<img src="' + photoUrl + '" alt="' + master.name + '" class="accordion__block_img" onerror="this.src=\'' + DEFAULT_AVATAR_URL + '\'">' +
                        '<div>' +
                        '<div class="accordion__block_master">' + master.name + '</div>' +
                        '<div style="font-size: 12px; color: #666;">' + master.specialty + '</div>' +
                        '</div>' +
                        '</div>'
                    );
                    
                    $masterBlock.on('click', function() {
                        // Сохраняем выбранного мастера
                        selectedData.master = {
                            id: master.id,
                            name: master.name,
                            photo_url: photoUrl,
                            specialty: master.specialty
                        };
                        
                        updateButtonTexts();
                        $('.service__masters .accordion').removeClass('active');
                        $panel.slideUp(200);

                        $('#selectedDateInfo').show();
                        $('#selectedDateText').text('(выберите дату выше)');
                        
                        console.log('Выбран мастер:', master.name);
                        
                        // Фильтруем другие опции
                        filterOptions();
                    });
                    
                    $panel.append($masterBlock);
                });
            },
            error: function(error) {
                console.error('Ошибка загрузки мастеров:', error);
                alert('Не удалось загрузить список мастеров');
            }
        });
    }

    // Обработчики даты и времени
    $('#appointmentDate').on('change', function() {
        var selectedDate = $(this).val();
        if (selectedDate) {
            selectedData.date = selectedDate;
            $('#selectedDateText').text(formatDate(selectedDate));
            $('#selectedDateInfo').show();
            console.log('Выбрана дата:', selectedDate);
            
            $('.time__elems_btn').removeClass('active selected');
        }
    });

    $(document).on('click', '.time__elems_btn', function() {
        var selectedDate = $('#appointmentDate').val();
        var selectedTime = $(this).data('time');
        
        if (!selectedDate) {
            alert('Сначала выберите дату');
            return;
        }
        
        if (!validateDateTime(selectedDate, selectedTime)) {
            $('.time__elems_btn').removeClass('active selected');
            return;
        }
        
        selectedData.time = selectedTime;
        $('.time__elems_btn').removeClass('active selected');
        $(this).addClass('active selected');
        
        console.log('Выбрано время:', selectedTime, 'на дату:', selectedDate);
    });

    // Обработчик кнопки "Далее"
    $('.time__btns_next').on('click', function() {
        console.log('Нажата кнопка "Далее"');
        console.log('Выбранные данные:', selectedData);
        
        // Проверка валидации даты и времени
        if (!validateDateTime(selectedData.date, selectedData.time)) {
            return;
        }
        
        // Проверка заполнения всех полей
        var missing = [];
        if (!selectedData.salon) missing.push('салон');
        if (!selectedData.service) missing.push('услуга');
        if (!selectedData.master) missing.push('мастер');
        if (!selectedData.date) missing.push('дата');
        if (!selectedData.time) missing.push('время');
        
        if (missing.length > 0) {
            alert('Пожалуйста, заполните все поля. Отсутствует: ' + missing.join(', '));
            return;
        }
        
        // Сохраняем данные в сессии
        $.ajax({
            url: '/api/save-appointment/',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                salon_id: selectedData.salon.id,
                service_id: selectedData.service.id,
                master_id: selectedData.master.id,
                date: selectedData.date,
                time: selectedData.time
            }),
            success: function(response) {
                if (response.success) {
                    window.location.href = response.redirect_url || '{% url "beauty_city_web:service_finally" %}';
                } else {
                    alert('Ошибка: ' + (response.error || 'Неизвестная ошибка при сохранении записи'));
                }
            },
            error: function(error) {
                console.error('Ошибка сохранения записи:', error);
                if (error.status === 404) {
                    alert('Запись сохранена. Переход на страницу подтверждения...');
                    window.location.href = '{% url "beauty_city_web:service_finally" %}';
                } else {
                    alert('Ошибка при сохранении записи. Пожалуйста, попробуйте еще раз.');
                }
            }
        });
    });

    // Обработчик кнопки "На главную"
    $('.time__btns_home').on('click', function() {
        window.location.href = '{% url "beauty_city_web:index" %}';
    });

    // Обработчик для кнопки "Запись по телефону"
    $('.telephoneAppointmentOpen').on('click', function() {
        $('#appointmentModal').arcticmodal();
    });
    
    // Устанавливаем минимальную дату (сегодня)
    var today = new Date().toISOString().split('T')[0];
    $('#appointmentDate').attr('min', today);
    $('#appointmentDate').val(today);
    $('#selectedDateText').text(formatDate(today));
    $('#selectedDateInfo').show();
    
    // Инициализация - загружаем все опции
    loadSalons();
    loadServices();
    loadMasters();
});
</script>
	{%endblock scripts %}
</body>
</html>